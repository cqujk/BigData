<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>股票可视化</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="home.css">
</head>
<body>
<div class="container mt-5">
    <div class="row">
        <!-- 日期信息 -->
        <div class="col-12 mb-3">
            <h2 id="date-info" class="text-center">当前日期: <span th:text="${currentDate}"></span></h2>
        </div>
    </div>
    <h2>已获取新闻列表</h2>
    <div class="row">
        <!-- 股票新闻列表 -->
        <div class="col-3">
            <div class="list-group" id="news-list">
                <a th:each="news : ${newsList}" th:href="${news.url}" target="_blank" class="list-group-item list-group-item-action">
                    <span th:text="${news.title}"></span>
                </a>
            </div>
        </div>
        <!-- 折线图 -->
        <div class="col-9">
            <canvas id="stock-chart" style="height: 400px;"></canvas>
        </div>
    </div>
    <div class="row mt-5">
        <!-- 股票列表 -->
        <div class="col-12">
            <h2>股票列表</h2>
            <table class="table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>名称</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="stock : ${stocks}">
                    <td th:text="${stock.id}"></td>
                    <td th:text="${stock.name}"></td>
                    <td><a th:href="@{/stock/{id}(id=${stock.id})}" class="btn btn-primary">查看详情</a></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- 引入 Chart.js 用于绘制折线图 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>    // 假设你有一个股票数据数组
// const NstocksData ='${stocksData}';
// let stocksData = [[${stocksData}]];
const stocksData = [[]];
// // console.log("sss:",${stocksData});
// console.log("原始的股票数据 JSON 字符串:", stocksData);
// 解析JSON字符串为JavaScript对象
// const stocksData = '${T(com.google.gson.Gson).fromJson(stocksData, T(java.util.List))}';
// let parsedStocksData = [];
// try {
    parsedStocksData = JSON.parse(${stocksData});
// } catch (e) {
//     console.error("解析JSON失败:", e);
// }
console.log("原始的股票数据:", stocksData);
// const stocksData=JSON.parse([[${stocksData}]]);
// console.log("转为JSON后的为",stocksData)
window.onload = function() {
    //
    const processedStocksData = stocksData.map(stockData => {
        const name = stockData['code'];
        const data = stockData['prices'].map(item => ({ date: item['date'], value: item['close_price'] }));
        const color = `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 0.2)`;
        const borderColor = `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`;
        return {
            name: name,
            data: data,
            color: color,
            borderColor: borderColor
        };
    });
    // // console.log("处理后的股票数据:", stocksData); // 输出处理后的股票数据
    // // console.log("原始的股票数据:", [[${stocksData}]]);
    // console.log("处理后的股票数据:", processedStocksData); // 输出处理后的股票数据
    const ctx = document.getElementById('stock-chart').getContext('2d');
    const datasets = processedStocksData.map(item => ({
        label: item.name,
        data: item.data.map(item1 => item1.value),
        backgroundColor: item.color,
        borderColor: item.borderColor,
        borderWidth: 1,
        fill: false
    }));
    const labels = processedStocksData[0].data.map(item => item.date);
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            tooltips: {
                mode: 'index',
                intersect: false
            },
            hover: {
                mode: 'nearest',
                intersect: true
            }
        }
    });
}
</script>
</body>
</html>
